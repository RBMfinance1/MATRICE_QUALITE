        <script>
function loadPhotos() {
            const savedPhotos = localStorage.getItem('productPhotos');
            if (savedPhotos) {
                const photosData = JSON.parse(savedPhotos);
                Object.keys(photosData).forEach(reference => {
                    const referenceId = reference.replace(/\s+/g, '_');
                    productPhotos[referenceId] = photosData[reference];
                    setTimeout(() => displayPhotos(referenceId), 200);
                });
            }
        }

        function resetQuality(referenceId) {
            if (confirm('üîÑ √ätes-vous s√ªr de vouloir r√©initialiser ce contr√¥le qualit√© complet ?')) {
                const matrix = document.querySelector(`input[name*="${referenceId}"]`).closest('.quality-matrix');
                
                const allInputs = matrix.querySelectorAll('input, textarea');
                allInputs.forEach(input => {
                    input.disabled = false;
                    if (input.type === 'radio' || input.type === 'checkbox') {
                        input.checked = false;
                    } else if (input.tagName === 'TEXTAREA') {
                        input.value = '';
                    }
                });
                
                const generalTextarea = document.getElementById(`remarks_${referenceId}`);
                if (generalTextarea) generalTextarea.value = '';
                
                matrix.classList.remove('quality-validated');
                
                const eanCriteria = matrix.querySelectorAll('.ean-criterion');
                eanCriteria.forEach(criterion => criterion.classList.remove('validated'));
                
                // Supprimer les photos
                if (productPhotos[referenceId]) {
                    productPhotos[referenceId] = [];
                    displayPhotos(referenceId);
                    savePhotos();
                }
                
                // Supprimer de localStorage
                const existingValidations = JSON.parse(localStorage.getItem('qualityValidations') || '[]');
                const filteredValidations = existingValidations.filter(v => v.reference !== referenceId.replace(/_/g, ' '));
                localStorage.setItem('qualityValidations', JSON.stringify(filteredValidations));
                
                saveEANValidations();
                
                alert('üîÑ Contr√¥le qualit√© complet r√©initialis√©.');
            }
</script>
        }<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matrice Qualit√©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
        }

        .search-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }

        .search-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            height: fit-content;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .results-section {
            margin-top: 30px;
        }

        .results-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .results-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .product-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }

        .product-title {
            color: #2c3e50;
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .product-brand {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
        }

        .product-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .detail-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .detail-value {
            color: #2c3e50;
            font-size: 0.95rem;
        }

        /* Styles pour la matrice qualit√© */
        .quality-matrix {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border-radius: 12px;
            border: 2px solid #28a745;
        }

        .quality-matrix h4 {
            color: #155724;
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .quality-criterion {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #28a745;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.1);
        }

        .criterion-label {
            display: block;
            font-weight: 600;
            color: #155724;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            color: #495057;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .checkbox-group label:hover {
            color: #28a745;
        }

        .checkbox-group input[type="radio"], .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
            cursor: pointer;
        }

        /* Styles sp√©cifiques pour les EAN */
        .ean-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #28a745;
        }

        .ean-section h5 {
            color: #155724;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ean-quality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .ean-criterion {
            border: 1px solid #2196f3 !important;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.1) !important;
        }

        .ean-criterion .criterion-label {
            color: #1565c0 !important;
        }

        .ean-code-display {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #424242;
            background: #f5f5f5;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            letter-spacing: 1px;
            font-weight: 600;
            margin: 8px 0;
        }

        .ean-criterion.validated {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0) !important;
            border-color: #28a745 !important;
        }

        .ean-criterion.validated .criterion-label {
            color: #155724 !important;
        }

        .quality-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .validate-btn, .reset-btn, .export-pdf-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .validate-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .validate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .reset-btn {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        .export-pdf-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .export-pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .remarks-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #28a745;
        }

        .remarks-section label {
            display: block;
            font-weight: 600;
            color: #155724;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .remarks-section textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .photo-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #28a745;
            margin-top: 15px;
        }

        .photo-section label {
            display: block;
            font-weight: 600;
            color: #155724;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .photo-upload {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .photo-upload input[type="file"] {
            flex: 1;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .photo-upload button {
            padding: 8px 15px;
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .photo-upload button:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(23, 162, 184, 0.3);
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .photo-item {
            position: relative;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .photo-item:hover {
            border-color: #28a745;
            transform: scale(1.02);
        }

        .photo-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            display: block;
        }

        .photo-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .photo-remove:hover {
            background: #dc3545;
            transform: scale(1.1);
        }

        .photo-info {
            padding: 5px;
            font-size: 0.7rem;
            color: #6c757d;
            text-align: center;
            background: rgba(248, 249, 250, 0.9);
        }

        .quality-validated {
            background: linear-gradient(135deg, #d4edda, #c3e6cb) !important;
            border-color: #28a745 !important;
        }

        .quality-validated h4::after {
            content: " ‚úÖ VALID√â";
            color: #155724;
            font-size: 0.8rem;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .search-container {
                flex-direction: column;
            }
            
            .product-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .product-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<script>
  const motDePasse = "2626";
  const saisie = prompt("üîí Cette page est prot√©g√©e. Veuillez entrer le mot de passe :");

  if (saisie !== motDePasse) {
    alert("‚õî Acc√®s refus√©.");
    window.location.href = "about:blank";
  }
</script>

    <div class="container">
        <h1>üîç Matrice Qualit√©</h1>
        
        <div class="search-section">
            <div style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <label for="csvFile" style="display: block; margin-bottom: 10px; font-weight: 600;">
                    üìÅ Charger le fichier BDD.csv depuis votre ordinateur :
                </label>
                <input type="file" id="csvFile" accept=".csv" style="margin-bottom: 10px;">
                <button onclick="loadFromFile()" style="background: #28a745;">Charger le fichier</button>
                <div id="fileStatus" style="margin-top: 10px; font-size: 0.9rem;"></div>
            </div>
            
            <div class="search-container">
                <div class="search-group">
                    <label for="referenceSearch">Recherche par r√©f√©rence</label>
                    <input type="text" id="referenceSearch" placeholder="Tapez une r√©f√©rence ou un mot-cl√©...">
                </div>
                <div class="search-group">
                    <label for="referenceSelect">Ou s√©lectionnez une r√©f√©rence</label>
                    <select id="referenceSelect">
                        <option value="">-- Toutes les r√©f√©rences --</option>
                    </select>
                </div>
                <button onclick="searchProducts()">Rechercher</button>
            </div>
            
            <div class="stats">
                <span id="dbStats">Chargement de la base de donn√©es...</span>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="searchStats"></span>
                    <button onclick="exportValidations()" style="background: #17a2b8; padding: 8px 15px; font-size: 0.8rem;">
                        üìä Exporter Validations
                    </button>
                </div>
            </div>
        </div>

        <div id="results" class="results-section" style="display: none;">
            <div class="results-header">
                <div class="results-title">R√©sultats de la recherche</div>
                <div class="results-count" id="resultsCount">0 r√©sultat</div>
            </div>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <script>
        let database = [];
        let allReferences = [];

        async function loadFromFile() {
            const fileInput = document.getElementById('csvFile');
            const fileStatus = document.getElementById('fileStatus');
            
            if (!fileInput.files[0]) {
                fileStatus.innerHTML = '<span style="color: #dc3545;">‚ùå Veuillez s√©lectionner un fichier</span>';
                return;
            }
            
            fileStatus.innerHTML = '<span style="color: #007bff;">‚è≥ Chargement en cours...</span>';
            
            try {
                const file = fileInput.files[0];
                const csvText = await file.text();
                
                const parsed = Papa.parse(csvText, {
                    header: true,
                    delimiter: ';',
                    skipEmptyLines: true,
                    encoding: 'UTF-8'
                });
                
                database = parsed.data.map(row => ({
                    reference: row['R√©f√©rence'] || row['RÔøΩfÔøΩrence'],
                    codeArticle: row['Code article'],
                    couleurFR: row['Couleur (FR)'],
                    couleurUS: row['Couleur (US)'],
                    taille: row['Taille'],
                    famille: row['Famille (FR)'],
                    marque: row['Marque'],
                    genre: row['Genre (FR)'],
                    ean: row['EAN'],
                    quantite: row['QT√â'] || row['QTÔøΩ'],
                    descriptifFR: row['Descriptif (FR)'],
                    composition: row['Composition (FR)'],
                    pays: row['Pays']
                })).filter(item => item.reference);
                
                allReferences = [...new Set(database.map(item => item.reference))];
                
                const select = document.getElementById('referenceSelect');
                select.innerHTML = '<option value="">-- Toutes les r√©f√©rences --</option>';
                allReferences.sort().forEach(ref => {
                    const option = document.createElement('option');
                    option.value = ref;
                    option.textContent = ref;
                    select.appendChild(option);
                });
                
                document.getElementById('dbStats').textContent = 
                    `Base de donn√©es: ${database.length} articles, ${allReferences.length} r√©f√©rences uniques`;
                
                fileStatus.innerHTML = '<span style="color: #28a745;">‚úÖ Fichier charg√© avec succ√®s!</span>';
                
                searchProducts();
                
            } catch (error) {
                console.error('Erreur:', error);
                fileStatus.innerHTML = '<span style="color: #dc3545;">‚ùå Erreur lors du chargement du fichier</span>';
            }
        }

        // Chargement initial avec donn√©es d'exemple
        async function loadDatabase() {
            try {
                database = [
                    {
                        reference: "ROYAUTE DB BLACK-BLACK MEN 068",
                        codeArticle: "WY1993H/GN",
                        couleurFR: "Noir / Noir",
                        couleurUS: "Black / Black",
                        taille: "S",
                        famille: "Softshell",
                        marque: "Geographical Norway",
                        genre: "Homme",
                        ean: "3543115515108",
                        quantite: 1,
                        descriptifFR: "SOFTSHELL HOMME AVEC CAPUCHE DETACHABLE ET AJUSTABLE, 2 POCHES ZIPPEE DEVANT ET 1 POCHE POITRINE DIAGONALE, MULTI BADGE EN PVC ET IMPRESSIONS. 2 BANDES IMPRIME A HAUTE DENSITE SUR DOS.",
                        composition: "4% Elasthanne, 96% Polyester",
                        pays: "CHINE"
                    },
                    {
                        reference: "ROYAUTE DB BLACK-BLACK MEN 068",
                        codeArticle: "WY1993H/GN",
                        couleurFR: "Noir / Noir",
                        couleurUS: "Black / Black",
                        taille: "M",
                        famille: "Softshell",
                        marque: "Geographical Norway",
                        genre: "Homme",
                        ean: "3543115515115",
                        quantite: 2,
                        descriptifFR: "SOFTSHELL HOMME AVEC CAPUCHE DETACHABLE ET AJUSTABLE, 2 POCHES ZIPPEE DEVANT ET 1 POCHE POITRINE DIAGONALE, MULTI BADGE EN PVC ET IMPRESSIONS. 2 BANDES IMPRIME A HAUTE DENSITE SUR DOS.",
                        composition: "4% Elasthanne, 96% Polyester",
                        pays: "CHINE"
                    },
                    {
                        reference: "ROYAUTE DB DGREY-BLACK MEN 068",
                        codeArticle: "WY1993H/GN",
                        couleurFR: "Gris Fonc√© / Noir",
                        couleurUS: "Dark Grey / Black",
                        taille: "L",
                        famille: "Softshell",
                        marque: "Geographical Norway",
                        genre: "Homme",
                        ean: "3543115515122",
                        quantite: 3,
                        descriptifFR: "SOFTSHELL HOMME AVEC CAPUCHE DETACHABLE ET AJUSTABLE, 2 POCHES ZIPPEE DEVANT ET 1 POCHE POITRINE DIAGONALE, MULTI BADGE EN PVC ET IMPRESSIONS. 2 BANDES IMPRIME A HAUTE DENSITE SUR DOS.",
                        composition: "4% Elasthanne, 96% Polyester",
                        pays: "CHINE"
                    }
                ];
                
                allReferences = [...new Set(database.map(item => item.reference))];
                
                const select = document.getElementById('referenceSelect');
                allReferences.sort().forEach(ref => {
                    const option = document.createElement('option');
                    option.value = ref;
                    option.textContent = ref;
                    select.appendChild(option);
                });
                
                document.getElementById('dbStats').textContent = 
                    `Base de donn√©es: ${database.length} articles, ${allReferences.length} r√©f√©rences uniques`;
                
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                document.getElementById('dbStats').textContent = 'Erreur de chargement';
            }
        }

        function searchProducts() {
            const searchText = document.getElementById('referenceSearch').value.toLowerCase().trim();
            const selectedRef = document.getElementById('referenceSelect').value;
            
            let filteredResults = [];
            
            if (selectedRef) {
                filteredResults = database.filter(item => item.reference === selectedRef);
            } else if (searchText) {
                filteredResults = database.filter(item => 
                    item.reference.toLowerCase().includes(searchText) ||
                    item.marque.toLowerCase().includes(searchText) ||
                    item.couleurFR.toLowerCase().includes(searchText) ||
                    item.famille.toLowerCase().includes(searchText)
                );
            } else {
                filteredResults = database;
            }
            
            displayResults(filteredResults);
            updateSearchStats(filteredResults.length, searchText || selectedRef);
        }

        function displayResults(results) {
            const resultsSection = document.getElementById('results');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsCount = document.getElementById('resultsCount');
            
            if (results.length === 0) {
                resultsSection.style.display = 'block';
                resultsCount.textContent = '0 r√©sultat';
                resultsContainer.innerHTML = '<div class="no-results">Aucun r√©sultat trouv√© pour cette recherche.</div>';
                return;
            }
            
            const groupedResults = {};
            results.forEach(item => {
                if (!groupedResults[item.reference]) {
                    groupedResults[item.reference] = [];
                }
                groupedResults[item.reference].push(item);
            });
            
            resultsSection.style.display = 'block';
            resultsCount.textContent = `${results.length} article${results.length > 1 ? 's' : ''} dans ${Object.keys(groupedResults).length} r√©f√©rence${Object.keys(groupedResults).length > 1 ? 's' : ''}`;
            
            let html = '';
            
            Object.entries(groupedResults).forEach(([reference, items]) => {
                const firstItem = items[0];
                const referenceId = reference.replace(/\s+/g, '_');
                
                html += `
                    <div class="product-card">
                        <div class="product-header">
                            <div>
                                <div class="product-title">${reference}</div>
                                <div class="product-brand">${firstItem.marque} - ${firstItem.famille}</div>
                            </div>
                        </div>
                        
                        <div class="product-details">
                            <div class="detail-item">
                                <div class="detail-label">Code Article</div>
                                <div class="detail-value">${firstItem.codeArticle}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Couleur</div>
                                <div class="detail-value">${firstItem.couleurFR}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Genre</div>
                                <div class="detail-value">${firstItem.genre}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem; color: #6c757d;">
                            <strong>Description:</strong> ${firstItem.descriptifFR}
                        </div>

                        <div class="quality-matrix">
                            <h4>‚úÖ Contr√¥le Qualit√©</h4>
                            
                            <!-- Contr√¥les g√©n√©raux -->
                            <div class="quality-grid">
                                <div class="quality-criterion">
                                    <span class="criterion-label">Shipping Marks</span>
                                    <div class="checkbox-group">
                                        <label><input type="radio" name="shipping_${referenceId}" value="ok"> OK</label>
                                        <label><input type="radio" name="shipping_${referenceId}" value="pas_ok"> PAS OK</label>
                                    </div>
                                    <textarea class="criterion-remarks" name="shipping_remarks_${referenceId}" placeholder="Remarques sur les Shipping Marks..."></textarea>
                                </div>
                                <div class="quality-criterion">
                                    <span class="criterion-label">EAN Colis</span>
                                    <div class="checkbox-group">
                                        <label><input type="radio" name="ean_colis_${referenceId}" value="ok"> OK</label>
                                        <label><input type="radio" name="ean_colis_${referenceId}" value="pas_ok"> PAS OK</label>
                                    </div>
                                    <textarea class="criterion-remarks" name="ean_colis_remarks_${referenceId}" placeholder="Remarques sur l'EAN Colis..."></textarea>
                                </div>
                                <div class="quality-criterion">
                                    <span class="criterion-label">√âtat du Colis</span>
                                    <div class="checkbox-group">
                                        <label><input type="radio" name="etat_${referenceId}" value="ok"> OK</label>
                                        <label><input type="radio" name="etat_${referenceId}" value="pas_ok"> PAS OK</label>
                                    </div>
                                    <textarea class="criterion-remarks" name="etat_remarks_${referenceId}" placeholder="Remarques sur l'√©tat du colis..."></textarea>
                                </div>
                                <div class="quality-criterion">
                                    <span class="criterion-label">Bande de Garantie</span>
                                    <div class="checkbox-group">
                                        <label><input type="radio" name="garantie_${referenceId}" value="ok"> OK</label>
                                        <label><input type="radio" name="garantie_${referenceId}" value="pas_ok"> PAS OK</label>
                                    </div>
                                    <textarea class="criterion-remarks" name="garantie_remarks_${referenceId}" placeholder="Remarques sur la bande de garantie..."></textarea>
                                </div>
                                <div class="quality-criterion">
                                    <span class="criterion-label">Zip</span>
                                    <div class="checkbox-group">
                                        <label><input type="radio" name="zip_${referenceId}" value="ok"> OK</label>
                                        <label><input type="radio" name="zip_${referenceId}" value="pas_ok"> PAS OK</label>
                                    </div>
                                    <textarea class="criterion-remarks" name="zip_remarks_${referenceId}" placeholder="Remarques sur les zips..."></textarea>
                                </div>
                                <div class="quality-criterion">
                                    <span class="criterion-label">Bouton</span>
                                    <div class="checkbox-group">
                                        <label><input type="radio" name="bouton_${referenceId}" value="ok"> OK</label>
                                        <label><input type="radio" name="bouton_${referenceId}" value="pas_ok"> PAS OK</label>
                                    </div>
                                    <textarea class="criterion-remarks" name="bouton_remarks_${referenceId}" placeholder="Remarques sur les boutons..."></textarea>
                                </div>
                                <div class="quality-criterion">
                                    <span class="criterion-label">Coloris</span>
                                    <div class="checkbox-group">
                                        <label><input type="radio" name="coloris_${referenceId}" value="ok"> OK</label>
                                        <label><input type="radio" name="coloris_${referenceId}" value="pas_ok"> PAS OK</label>
                                    </div>
                                    <textarea class="criterion-remarks" name="coloris_remarks_${referenceId}" placeholder="Remarques sur le coloris..."></textarea>
                                </div>
                            </div>
                            
                            <!-- Section Test EAN par taille int√©gr√©e -->
                            <div class="ean-section">
                                <h5>üîç Test EAN par Taille</h5>
                                <div class="ean-quality-grid">
                                    ${items.map(item => `
                                        <div class="quality-criterion ean-criterion">
                                            <span class="criterion-label">Taille ${item.taille}</span>
                                            <div class="ean-code-display">${item.ean}</div>
                                            <div class="checkbox-group">
                                                <label>
                                                    <input type="checkbox" name="ean_check_${referenceId}_${item.taille}" 
                                                           onchange="updateEANStatus(this)"> 
                                                    EAN Test√©
                                                </label>
                                            </div>
                                            <textarea class="criterion-remarks" name="ean_remarks_${referenceId}_${item.taille}" placeholder="Remarques sur l'EAN taille ${item.taille}..."></textarea>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="quality-actions">
                                <button class="reset-btn" onclick="resetQuality('${referenceId}')">
                                    üîÑ Reset
                                </button>
                                <button class="export-pdf-btn" onclick="exportToPDF('${referenceId}', '${reference}')">
                                    üìÑ Export PDF
                                </button>
                            </div>
                            
                            <div class="remarks-section">
                                <label for="remarks_${referenceId}">üìù Remarques :</label>
                                <textarea id="remarks_${referenceId}" placeholder="Ajouter des remarques sur ce produit..."></textarea>
                            </div>
                            
                            <div class="photo-section">
                                <label>üì∑ Photos du contr√¥le qualit√© :</label>
                                <div class="photo-upload">
                                    <input type="file" id="photoInput_${referenceId}" accept="image/*" multiple>
                                    <button onclick="addPhotos('${referenceId}')">Ajouter</button>
                                </div>
                                <div class="photo-gallery" id="photoGallery_${referenceId}"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
            
            // Restaurer les validations apr√®s le rendu
            setTimeout(() => {
                restoreEANValidations();
                restoreQualityValidations();
                loadPhotos();
            }, 100);
        }

        // Gestion des photos
        let productPhotos = {};

        function addPhotos(referenceId) {
            const fileInput = document.getElementById(`photoInput_${referenceId}`);
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Veuillez s√©lectionner au moins une photo.');
                return;
            }
            
            if (!productPhotos[referenceId]) {
                productPhotos[referenceId] = [];
            }
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                    if (!e.target.result) return;
                        const photoData = {
                            name: file.name,
                            data: e.target.result,
                            size: (file.size / 1024).toFixed(1) + ' KB'
                        };
                        productPhotos[referenceId].push(photoData);
                        displayPhotos(referenceId);
                        savePhotos();
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            fileInput.value = '';
        }

        function displayPhotos(referenceId) {
            const gallery = document.getElementById(`photoGallery_${referenceId}`);
            if (!gallery || !productPhotos[referenceId]) return;
            
            gallery.innerHTML = '';
            
            productPhotos[referenceId].forEach((photo, index) => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                photoItem.innerHTML = `
                    <img src="${photo.data}" alt="${photo.name}" onclick="viewPhoto('${photo.data}', '${photo.name}')">
                    <button class="photo-remove" onclick="removePhoto('${referenceId}', ${index})" title="Supprimer">√ó</button>
                    <div class="photo-info">${photo.size}</div>
                `;
                gallery.appendChild(photoItem);
            });
        }

        function removePhoto(referenceId, index) {
            if (confirm('Supprimer cette photo ?')) {
                productPhotos[referenceId].splice(index, 1);
                displayPhotos(referenceId);
                savePhotos();
            }
        }

        function viewPhoto(src, name) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000; cursor: pointer;
            `;
            modal.innerHTML = `
                <div style="max-width: 90%; max-height: 90%; text-align: center;">
                    <img src="${src}" style="max-width: 100%; max-height: 80vh; border-radius: 8px;">
                    <div style="color: white; margin-top: 10px; font-size: 1.1rem;">${name}</div>
                    <div style="color: #ccc; margin-top: 5px; font-size: 0.9rem;">Cliquez pour fermer</div>
                </div>
            `;
            modal.onclick = () => document.body.removeChild(modal);
            document.body.appendChild(modal);
        }

        function savePhotos() {
            const photosToSave = {};
            Object.keys(productPhotos).forEach(key => {
                const reference = key.replace(/_/g, ' ');
                photosToSave[reference] = productPhotos[key];
            });
            localStorage.setItem('productPhotos', JSON.stringify(photosToSave));
        }

        function updateSearchStats(count, query) {
            const searchStats = document.getElementById('searchStats');
            if (query) {
                searchStats.textContent = `Recherche: "${query}" - ${count} r√©sultat${count > 1 ? 's' : ''}`;
            } else {
                searchStats.textContent = '';
            }
        }

        // Recherche en temps r√©el
        document.getElementById('referenceSearch').addEventListener('input', function() {
            if (this.value.length >= 2) {
                document.getElementById('referenceSelect').value = '';
                searchProducts();
            }
        });

        document.getElementById('referenceSelect').addEventListener('change', function() {
            document.getElementById('referenceSearch').value = '';
            searchProducts();
        });

        function updateEANStatus(checkbox) {
            const eanCriterion = checkbox.closest('.ean-criterion');
            if (checkbox.checked) {
                eanCriterion.classList.add('validated');
            } else {
                eanCriterion.classList.remove('validated');
            }
            saveEANValidations();
        }

        function saveEANValidations() {
            const allEANChecks = document.querySelectorAll('input[name^="ean_check_"]:checked');
            const validatedEANs = Array.from(allEANChecks).map(checkbox => {
                const name = checkbox.name;
                const parts = name.split('_');
                const reference = parts.slice(2, -1).join('_');
                const taille = parts[parts.length - 1];
                return {
                    reference: reference.replace(/_/g, ' '),
                    taille: taille,
                    timestamp: new Date().toISOString()
                };
            });
            localStorage.setItem('validatedEANs', JSON.stringify(validatedEANs));
        }

        function restoreEANValidations() {
            const validatedEANs = JSON.parse(localStorage.getItem('validatedEANs') || '[]');
            validatedEANs.forEach(validation => {
                const checkbox = document.querySelector(`input[name="ean_check_${validation.reference.replace(/\s+/g, '_')}_${validation.taille}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    updateEANStatus(checkbox);
                }
            });
        }

        function validateQuality(referenceId) {
            const matrix = document.querySelector(`input[name*="${referenceId}"]`).closest('.quality-matrix');
            const radios = matrix.querySelectorAll('input[type="radio"]:checked');
            
            if (radios.length < 7) {
                alert('‚ö†Ô∏è Veuillez compl√©ter tous les crit√®res de contr√¥le avant de valider.');
                return;
            }
            
            matrix.classList.add('quality-validated');
            
            const allRadios = matrix.querySelectorAll('input[type="radio"]');
            const allTextareas = matrix.querySelectorAll('textarea');
            allRadios.forEach(radio => radio.disabled = true);
            allTextareas.forEach(textarea => textarea.disabled = true);
            
            const results = {};
            const criterionRemarks = {};
            
            // R√©cup√©rer les r√©ponses radio
            radios.forEach(radio => {
                const criterionName = radio.name.split('_')[0];
                results[criterionName] = radio.value;
            });
            
            // R√©cup√©rer les remarques pour chaque crit√®re
            const remarkTextareas = matrix.querySelectorAll('textarea[name*="_remarks_"]');
            remarkTextareas.forEach(textarea => {
                if (textarea.value.trim()) {
                    const criterionName = textarea.name.replace(`_remarks_${referenceId}`, '').replace(`_${referenceId}`, '');
                    criterionRemarks[criterionName] = textarea.value.trim();
                }
            });
            
            const generalRemarks = document.getElementById(`remarks_${referenceId}`).value;
            
            const validationData = {
                reference: referenceId.replace(/_/g, ' '),
                results: results,
                criterionRemarks: criterionRemarks,
                remarks: generalRemarks,
                timestamp: new Date().toISOString(),
                validator: 'Utilisateur'
            };
            
            const existingValidations = JSON.parse(localStorage.getItem('qualityValidations') || '[]');
            const existingIndex = existingValidations.findIndex(v => v.reference === validationData.reference);
            if (existingIndex >= 0) {
                existingValidations[existingIndex] = validationData;
            } else {
                existingValidations.push(validationData);
            }
            localStorage.setItem('qualityValidations', JSON.stringify(existingValidations));
            
            alert('‚úÖ Contr√¥le qualit√© valid√© et sauvegard√© !');
        }

        function restoreQualityValidations() {
            const qualityValidations = JSON.parse(localStorage.getItem('qualityValidations') || '[]');
            qualityValidations.forEach(validation => {
                const referenceId = validation.reference.replace(/\s+/g, '_');
                const matrix = document.querySelector(`input[name*="${referenceId}"]`)?.closest('.quality-matrix');
                if (!matrix) return;
                
                // Restaurer les r√©ponses radio
                Object.entries(validation.results).forEach(([criterion, value]) => {
                    const radio = matrix.querySelector(`input[name="${criterion}_${referenceId}"][value="${value}"]`);
                    if (radio) radio.checked = true;
                });
                
                // Restaurer les remarques par crit√®re
                if (validation.criterionRemarks) {
                    Object.entries(validation.criterionRemarks).forEach(([criterion, remark]) => {
                        const textarea = matrix.querySelector(`textarea[name="${criterion}_remarks_${referenceId}"], textarea[name*="${criterion}_remarks_${referenceId}"]`);
                        if (textarea) textarea.value = remark;
                    });
                }
                
                // Restaurer les remarques g√©n√©rales
                const remarksField = document.getElementById(`remarks_${referenceId}`);
                if (remarksField) remarksField.value = validation.remarks || '';
                
                // Marquer comme valid√©
                matrix.classList.add('quality-validated');
                const allRadios = matrix.querySelectorAll('input[type="radio"]');
                const allTextareas = matrix.querySelectorAll('textarea');
                allRadios.forEach(radio => radio.disabled = true);
                allTextareas.forEach(textarea => textarea.disabled = true);
            });
        }

        function resetQuality(referenceId) {
            if (confirm('üîÑ √ätes-vous s√ªr de vouloir r√©initialiser ce contr√¥le qualit√© complet ?')) {
                const matrix = document.querySelector(`input[name*="${referenceId}"]`).closest('.quality-matrix');
                
                const allInputs = matrix.querySelectorAll('input, textarea');
                allInputs.forEach(input => {
                    input.disabled = false;
                    if (input.type === 'radio' || input.type === 'checkbox') {
                        input.checked = false;
                    } else if (input.tagName === 'TEXTAREA') {
                        input.value = '';
                    }
                });
                
                const generalTextarea = document.getElementById(`remarks_${referenceId}`);
                if (generalTextarea) generalTextarea.value = '';
                
                matrix.classList.remove('quality-validated');
                
                const eanCriteria = matrix.querySelectorAll('.ean-criterion');
                eanCriteria.forEach(criterion => criterion.classList.remove('validated'));
                
                // Supprimer de localStorage
                const existingValidations = JSON.parse(localStorage.getItem('qualityValidations') || '[]');
                const filteredValidations = existingValidations.filter(v => v.reference !== referenceId.replace(/_/g, ' '));
                localStorage.setItem('qualityValidations', JSON.stringify(filteredValidations));
                
                saveEANValidations();
                
                alert('üîÑ Contr√¥le qualit√© complet r√©initialis√©.');
            }
        }

        function exportToPDF(referenceId, originalReference) {
            // V√©rification avant export
            const matrix = document.querySelector(`input[name*="${referenceId}"]`).closest('.quality-matrix');
            const radios = matrix.querySelectorAll('input[type="radio"]:checked');
            
            if (radios.length < 7) {
                alert('‚ö†Ô∏è Impossible d\'exporter le PDF : Veuillez compl√©ter tous les crit√®res de contr√¥le avant l\'export.\n\nCrit√®res manquants : ' + (7 - radios.length));
                return;
            }
            
            // Validation automatique avant export
            validateQualityForExport(referenceId);
            
            const referenceData = database.filter(item => item.reference === originalReference);
            if (referenceData.length === 0) {
                alert('‚ùå Aucune donn√©e trouv√©e pour cette r√©f√©rence.');
                return;
            }

            const firstItem = referenceData[0];
            const qualityValidations = JSON.parse(localStorage.getItem('qualityValidations') || '[]');
            const qualityData = qualityValidations.find(v => v.reference === originalReference);
            const eanValidations = JSON.parse(localStorage.getItem('validatedEANs') || '[]');
            const eanData = eanValidations.filter(v => v.reference === originalReference);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = 20;
            
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('MATRICE QUALIT√â', 20, yPosition);
            
            yPosition += 10;
            doc.setFontSize(14);
            doc.setFont(undefined, 'normal');
            doc.text(`Date: ${new Date().toLocaleString('fr-FR')}`, 20, yPosition);
            
            yPosition += 20;
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('INFORMATIONS PRODUIT', 20, yPosition);
            
            yPosition += 10;
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            
            const productInfo = [
                `R√©f√©rence: ${originalReference}`,
                `Code Article: ${firstItem.codeArticle}`,
                `Marque: ${firstItem.marque}`,
                `Famille: ${firstItem.famille}`,
                `Genre: ${firstItem.genre}`,
                `Couleur: ${firstItem.couleurFR}`
            ];
            
            productInfo.forEach(info => {
                doc.text(info, 20, yPosition);
                yPosition += 7;
            });
            
            yPosition += 10;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('TAILLES ET EAN', 20, yPosition);
            
            yPosition += 10;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            referenceData.forEach(item => {
                const eanTested = eanData.some(ean => ean.taille === item.taille);
                const status = eanTested ? '[‚úì] TEST√â' : '[ ] NON TEST√â';
                doc.text(`Taille ${item.taille}: ${item.ean} ${status}`, 20, yPosition);
                yPosition += 6;
                
                // Ajouter les remarques EAN sp√©cifiques √† cette taille s'il y en a
                const eanRemarkField = document.querySelector(`textarea[name="ean_remarks_${referenceId}_${item.taille}"]`);
                if (eanRemarkField && eanRemarkField.value.trim()) {
                    doc.setFontSize(9);
                    const eanRemark = doc.splitTextToSize(`  ‚Üí ${eanRemarkField.value.trim()}`, 165);
                    doc.text(eanRemark, 25, yPosition);
                    yPosition += eanRemark.length * 5;
                    doc.setFontSize(10);
                }
            });
            
            yPosition += 10;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('CONTR√îLE QUALIT√â', 20, yPosition);
            
            yPosition += 10;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            if (qualityData) {
                const criteria = [
                    { key: 'shipping', label: 'Shipping Marks' },
                    { key: 'ean', label: 'EAN Colis' },
                    { key: 'etat', label: '√âtat du Colis' },
                    { key: 'garantie', label: 'Bande de Garantie' },
                    { key: 'zip', label: 'Zip' },
                    { key: 'bouton', label: 'Bouton' },
                    { key: 'coloris', label: 'Coloris' }
                ];
                
                criteria.forEach(criterion => {
                    const value = qualityData.results[criterion.key];
                    const status = value ? (value.toLowerCase() === 'ok' ? '[‚úì] OK' : '[‚úó] PAS OK') : '[ ] NON RENSEIGN√â';
                    doc.text(`${criterion.label}: ${status}`, 20, yPosition);
                    yPosition += 6;
                    
                    // Ajouter les remarques sp√©cifiques du crit√®re s'il y en a
                    if (qualityData.criterionRemarks && qualityData.criterionRemarks[criterion.key]) {
                        doc.setFontSize(9);
                        const criterionRemark = doc.splitTextToSize(`  ‚Üí ${qualityData.criterionRemarks[criterion.key]}`, 165);
                        doc.text(criterionRemark, 25, yPosition);
                        yPosition += criterionRemark.length * 5;
                        doc.setFontSize(10);
                    }
                });
                
                if (qualityData.remarks) {
                    yPosition += 5;
                    doc.text('Remarques g√©n√©rales:', 20, yPosition);
                    yPosition += 6;
                    const remarks = doc.splitTextToSize(qualityData.remarks, 170);
                    doc.text(remarks, 20, yPosition);
                    yPosition += remarks.length * 6;
                }
                
                yPosition += 10;
                doc.text(`Valid√© le: ${new Date(qualityData.timestamp).toLocaleString('fr-FR')}`, 20, yPosition);
                doc.text(`Par: ${qualityData.validator}`, 20, yPosition + 6);
                yPosition += 15;
                
            } else {
                doc.text('‚ùå Contr√¥le qualit√© non effectu√©', 20, yPosition);
                yPosition += 15;
            }
            
            // Ajouter les photos si pr√©sentes
            const photos = productPhotos[referenceId];
            if (photos && photos.length > 0) {
                // V√©rifier s'il reste de la place sur la page actuelle
                if (yPosition > 200) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('PHOTOS DU CONTR√îLE', 20, yPosition);
                yPosition += 15;
                
                const photosPerRow = 2;
                const photoWidth = 80;
                const photoHeight = 60;
                const margin = 10;
                
                photos.forEach((photo, index) => {
                    const row = Math.floor(index / photosPerRow);
                    const col = index % photosPerRow;
                    
                    const x = 20 + col * (photoWidth + margin);
                    const y = yPosition + row * (photoHeight + 15);
                    
                    // V√©rifier si on doit ajouter une nouvelle page
                    if (y + photoHeight > 280) {
                        doc.addPage();
                        yPosition = 20;
                        const newRow = Math.floor((index - (row * photosPerRow)) / photosPerRow);
                        const newY = yPosition + newRow * (photoHeight + 15);
                        
                        try {
                            doc.addImage(photo.data, 'JPEG', x, newY, photoWidth, photoHeight);
                            doc.setFontSize(8);
                            doc.text(photo.name, x, newY + photoHeight + 8);
                        } catch (e) {
                            console.log('Erreur lors de l\'ajout de l\'image:', e);
                        }
                    } else {
                        try {
                            doc.addImage(photo.data, 'JPEG', x, y, photoWidth, photoHeight);
                            doc.setFontSize(8);
                            doc.text(photo.name, x, y + photoHeight + 8);
                        } catch (e) {
                            console.log('Erreur lors de l\'ajout de l\'image:', e);
                        }
                    }
                });
                
                // Calculer la nouvelle position Y apr√®s les photos
                const totalRows = Math.ceil(photos.length / photosPerRow);
                yPosition += totalRows * (photoHeight + 15) + 10;
            }
            
            // Description produit (si reste de la place)
            if (yPosition < 250) {
                yPosition += 10;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('DESCRIPTION', 20, yPosition);
                
                yPosition += 10;
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const description = doc.splitTextToSize(firstItem.descriptifFR, 170);
                doc.text(description, 20, yPosition);
            }
            
            // Pied de page sur la derni√®re page
            const pageCount = doc.internal.getNumberOfPages();
            doc.setPage(pageCount);
            doc.setFontSize(8);
            doc.setFont(undefined, 'italic');
            doc.text('Document g√©n√©r√© automatiquement par Matrice Qualit√©', 20, 285);
            
            const filename = `${originalReference.replace(/[^\w\s-]/g, '').replace(/\s+/g, '_')}.pdf`;
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                window.open(doc.output('bloburl'));
            } else {
                
const blob = doc.output('blob');
const blobUrl = URL.createObjectURL(new Blob([blob], { type: 'application/pdf' }));
const link = document.createElement('a');
link.href = blobUrl;
link.download = filename;
document.body.appendChild(link);
link.click();
document.body.removeChild(link);

            }
            
            alert(`‚úÖ Contr√¥le qualit√© valid√© et PDF export√©: ${filename}`);
        }

        // Fonction de validation automatique pour l'export (sans interface utilisateur)
        function validateQualityForExport(referenceId) {
            const matrix = document.querySelector(`input[name*="${referenceId}"]`).closest('.quality-matrix');
            const radios = matrix.querySelectorAll('input[type="radio"]:checked');
            
            // Marquer visuellement comme valid√©
            matrix.classList.add('quality-validated');
            
            // D√©sactiver les contr√¥les pour indiquer la validation
            const allRadios = matrix.querySelectorAll('input[type="radio"]');
            const allTextareas = matrix.querySelectorAll('textarea');
            allRadios.forEach(radio => radio.disabled = true);
            allTextareas.forEach(textarea => textarea.disabled = true);
            
            const results = {};
            const criterionRemarks = {};
            
            // R√©cup√©rer les r√©ponses radio
            radios.forEach(radio => {
                const criterionName = radio.name.split('_')[0];
                results[criterionName] = radio.value;
            });
            
            // R√©cup√©rer les remarques pour chaque crit√®re
            const remarkTextareas = matrix.querySelectorAll('textarea[name*="_remarks_"]');
            remarkTextareas.forEach(textarea => {
                if (textarea.value.trim()) {
                    const criterionName = textarea.name.replace(`_remarks_${referenceId}`, '').replace(`_${referenceId}`, '');
                    criterionRemarks[criterionName] = textarea.value.trim();
                }
            });
            
            const generalRemarks = document.getElementById(`remarks_${referenceId}`).value;
            
            const validationData = {
                reference: referenceId.replace(/_/g, ' '),
                results: results,
                criterionRemarks: criterionRemarks,
                remarks: generalRemarks,
                timestamp: new Date().toISOString(),
                validator: 'Utilisateur'
            };
            
            const existingValidations = JSON.parse(localStorage.getItem('qualityValidations') || '[]');
            const existingIndex = existingValidations.findIndex(v => v.reference === validationData.reference);
            if (existingIndex >= 0) {
                existingValidations[existingIndex] = validationData;
            } else {
                existingValidations.push(validationData);
            }
            localStorage.setItem('qualityValidations', JSON.stringify(existingValidations));
            
            // Sauvegarder aussi les remarques EAN dans le localStorage des EAN
            const eanRemarkTextareas = matrix.querySelectorAll('textarea[name*="ean_remarks_"]');
            const eanValidations = JSON.parse(localStorage.getItem('validatedEANs') || '[]');
            
            eanRemarkTextareas.forEach(textarea => {
                if (textarea.value.trim()) {
                    const name = textarea.name;
                    const parts = name.split('_');
                    const reference = parts.slice(2, -1).join('_');
                    const taille = parts[parts.length - 1];
                    
                    // Trouver ou cr√©er l'entr√©e EAN
                    let eanEntry = eanValidations.find(v => v.reference === reference.replace(/_/g, ' ') && v.taille === taille);
                    if (!eanEntry) {
                        eanEntry = {
                            reference: reference.replace(/_/g, ' '),
                            taille: taille,
                            timestamp: new Date().toISOString()
                        };
                        eanValidations.push(eanEntry);
                    }
                    eanEntry.remarks = textarea.value.trim();
                }
            });
            
            localStorage.setItem('validatedEANs', JSON.stringify(eanValidations));
        }

        function exportValidations() {
            const qualityValidations = JSON.parse(localStorage.getItem('qualityValidations') || '[]');
            const eanValidations = JSON.parse(localStorage.getItem('validatedEANs') || '[]');
            
            if (qualityValidations.length === 0 && eanValidations.length === 0) {
                alert('üìÑ Aucune validation √† exporter.');
                return;
            }
            
            let csv = 'Type,R√©f√©rence,Taille,Crit√®re,Valeur,Remarques,Date Validation,Validateur\n';
            
            qualityValidations.forEach(validation => {
                Object.entries(validation.results).forEach(([criterion, value]) => {
                    const row = [
                        'Contr√¥le Qualit√©',
                        validation.reference,
                        '',
                        criterion,
                        value,
                        `"${validation.remarks || ''}"`,
                        new Date(validation.timestamp).toLocaleString('fr-FR'),
                        validation.validator
                    ].join(',');
                    csv += row + '\n';
                });
                
                // Ajouter les remarques par crit√®re
                if (validation.criterionRemarks) {
                    Object.entries(validation.criterionRemarks).forEach(([criterion, remark]) => {
                        const row = [
                            'Remarque Crit√®re',
                            validation.reference,
                            '',
                            criterion,
                            'Remarque',
                            `"${remark}"`,
                            new Date(validation.timestamp).toLocaleString('fr-FR'),
                            validation.validator
                        ].join(',');
                        csv += row + '\n';
                    });
                }
            });
            
            eanValidations.forEach(validation => {
                const row = [
                    'Test EAN',
                    validation.reference,
                    validation.taille,
                    'EAN Test√©',
                    'OK',
                    '',
                    new Date(validation.timestamp).toLocaleString('fr-FR'),
                    'Utilisateur'
                ].join(',');
                csv += row + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `validations_completes_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            const totalEANs = document.querySelectorAll('input[name^="ean_check_"]').length;
            const validatedEANCount = eanValidations.length;
            const percentage = totalEANs > 0 ? ((validatedEANCount / totalEANs) * 100).toFixed(1) : 0;
            
            alert(`üìä Export termin√© !\n\nR√©sum√©:\n‚Ä¢ ${qualityValidations.length} contr√¥les qualit√©\n‚Ä¢ ${validatedEANCount}/${totalEANs} EAN test√©s (${percentage}%)`);
        }

        // Chargement initial
        loadDatabase();
        setTimeout(() => {
            searchProducts();
        }, 500);
    </script>
</body>
</html>